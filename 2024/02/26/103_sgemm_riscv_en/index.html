<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="This project records the process of optimizing SGEMM (single-precision floating point General Matrix Multiplication) on the riscv platform.">
<meta property="og:type" content="article">
<meta property="og:title" content="Optimize sgemm on RISC-V platform">
<meta property="og:url" content="http://example.com/2024/02/26/103_sgemm_riscv_en/index.html">
<meta property="og:site_name" content="Zhao Dongyu&#39;s Blog">
<meta property="og:description" content="This project records the process of optimizing SGEMM (single-precision floating point General Matrix Multiplication) on the riscv platform.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-02-25T16:00:00.000Z">
<meta property="article:modified_time" content="2024-10-14T06:11:14.904Z">
<meta property="article:author" content="Zhao Dongyu">
<meta property="article:tag" content="RISCV">
<meta property="article:tag" content="GEMM">
<meta property="article:tag" content="HPC">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2024/02/26/103_sgemm_riscv_en/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Optimize sgemm on RISC-V platform | Zhao Dongyu's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-47NXH2LPKW"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-47NXH2LPKW');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Zhao Dongyu's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zhao Dongyu's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">A life which is unexamined is not worth living.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-rss">

    <a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/Zhao-Dongyu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/26/103_sgemm_riscv_en/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zhaodongyu.jpg">
      <meta itemprop="name" content="Zhao Dongyu">
      <meta itemprop="description" content="Here is Zhao Dongyu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhao Dongyu's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Optimize sgemm on RISC-V platform
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-26 00:00:00" itemprop="dateCreated datePublished" datetime="2024-02-26T00:00:00+08:00">2024-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 14:11:14" itemprop="dateModified" datetime="2024-10-14T14:11:14+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This project records the process of optimizing SGEMM
(single-precision floating point General Matrix Multiplication) on the
riscv platform.</p>
<p><img src=/images/sgemm/data/result_all.png width=70% /></p>
<span id="more"></span>
<p>This project records the process of optimizing SGEMM
(single-precision floating point General Matrix Multiplication) on the
riscv platform.</p>
<p>General Matrix Multiplication (GEMM) is one of the core computing
units in deep learning frameworks, widely used for implementing
operators such as Convolution, Full Connection, and Matmul.</p>
<p>I conducted experiments and explorations on the <strong>Allwinner
Nezha D1</strong> development board. <code>Versions 0 through 5</code>
were implemented using the C language, while
<code>versions 6 through 9</code> partially utilized assembly language,
involving the <code>RISC-V V</code> extension instructions.</p>
<p>Note: Unlike some other GEMM optimization projects, this project uses
<strong>row-major order</strong> matrices exclusively. Because I prefer
<strong>row-major order</strong>!</p>
<h1 id="prerequisite-knowledge">Prerequisite Knowledge</h1>
<p><img src=/images/sgemm/pics/riscv.gif width=50% /></p>
<p><a target="_blank" rel="noopener" href="https://riscv.org/">RISC-V</a> is an open standard
Instruction Set Architecture (ISA) enabling a new era of processor
innovation through open collaboration.</p>
<hr />
<p><img src=/images/sgemm/pics/GEMM.png width=70% /></p>
<p><a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprograms#Level_3">GEMM</a>
General matrix multiply, one of the Basic Linear Algebra
Subprograms.</p>
<hr />
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/FLOPS">FLOPS</a> stands for
Floating-point Operations Per Second, also known as peak speed per
second. It refers to the number of floating-point operations executed
per second. One <strong>gigaflop (GFLOPS)</strong> equals ten to the
power of nine (10^9) floating-point operations per second.</p>
<p>The computational complexity of matrix multiplication is calculated
as <code>2 * M * N * K</code>. The ratio of computational complexity to
time taken gives the GFLOPS of the current GEMM version. - Multiplying
by 2 is because each operation involves one multiplication and one
addition.</p>
<h1 id="prepare">Prepare</h1>
<p>The related code is located in <code>./prepare/</code>.</p>
<h2 id="test-cross-compilation">Test Cross-Compilation</h2>
<p>I use the <strong>Allwinner Nezha D1</strong> development board, and
downloaded the cross-compilation link from <a
target="_blank" rel="noopener" href="https://xuantie.t-head.cn/community/download?id=4090445921563774976">here</a>.</p>
<p>For detailed instructions, please refer to the <a
target="_blank" rel="noopener" href="https://github.com/Zhao-Dongyu/sgemm_riscv/blob/main/prepare/README.md">readme</a>.</p>
<h2 id="memory-bandwidth-test">Memory Bandwidth Test</h2>
<p>I conducted memory bandwidth tests on the development board using the
following projects:</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://github.com/Zhao-Dongyu/sgemm_riscv/tree/main/prepare/2.memcpy_bandwidth_test">2.memcpy_bandwidth_test</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/Zhao-Dongyu/sgemm_riscv/tree/main/prepare/3.flw_bandwidth_test">3.flw_bandwidth_test</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/Zhao-Dongyu/sgemm_riscv/tree/main/prepare/4.vlw_bandwidth_test">4.vlw_bandwidth_test</a></li>
</ul>
<p><img src=/images/sgemm/prepare/imgs/memory_bandwidth_test.png width=70% /></p>
<h2 id="roofline-model">Roofline Model</h2>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Roofline_model">Roofline</a>
proposes a method for quantitative analysis using "Operational
Intensity" and provides a formula for the theoretical performance limit
achievable on computational platforms.</p>
<p>According to <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/474684731">OpenPPL
Public Course | RISC-V Technical Analysis</a>:</p>
<ul>
<li>The computing power of D1 can reach <code>4 GFlops</code> (<span
class="citation" data-cites="1GHz">@1GHz</span>).</li>
<li>Memory: <code>2.727 GB/s</code> (DDR3 792 MHz).
<ul>
<li>Although I measured the highest as <code>2.592 GB/s</code>, there
may be some problems somewhere?</li>
<li>Let's trust Sensetime for now, temporarily accept its value.</li>
</ul></li>
</ul>
<p><img src=/images/sgemm/pics/roofline.png width=70% /></p>
<h1 id="sgemm-optimization">SGEMM Optimization</h1>
<p>Related code is located in <code>./sgemm/</code>.</p>
<h2 id="usage">Usage</h2>
<p>Take <code>step0</code> as an example, you need to edit the Makefile
first to configure your cross-compilation chain.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> sgemm/step0/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb push test_bl_sgemm_step0.x ./.</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb shell <span class="string">&#x27;./test_bl_sgemm_step0.x&#x27;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="version-0-naive-version">Version 0: Naive Version</h2>
<p>This version seems to be <strong>the most intuitive</strong> to me,
after all, this is how I learned, understood, and computed matrix
multiplication: &gt; Multiply one row of A by one column of B to get one
element of C.</p>
<p><img src=/images/sgemm/data/result_0.png width=70% /></p>
<p><img src=/images/sgemm/pics/step0.gif width=70% /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; m; i ++ ) &#123;              <span class="comment">// Start 2-th loop</span></span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; n; j ++ ) &#123;          <span class="comment">// Start 1-nd loop</span></span><br><span class="line">        <span class="keyword">for</span> ( p = <span class="number">0</span>; p &lt; k; p ++ ) &#123;      <span class="comment">// Start 0-st loop</span></span><br><span class="line">            C( i, j ) += A( i, p ) * B( p, j );</span><br><span class="line">        &#125;                                 <span class="comment">// End   0-th loop</span></span><br><span class="line">    &#125;                                     <span class="comment">// End   1-st loop</span></span><br><span class="line">&#125;                                         <span class="comment">// End   2-nd loop</span></span><br></pre></td></tr></table></figure>
<p>I think <code>version 0</code> very well explains the formula <span
class="math inline">\(C_{mn} = \sum_{k=1}^{K} A_{mk}B_{kn}\)</span>.</p>
<p>However, this version has obvious shortcomings: on a platform with a
theoretical computing power of <code>4 GFLOPS</code>, it only achieves a
maximum computational performance of <code>0.03 GFLOPS</code>. This is
because <strong>the access to matrix B has a very low cache hit rate,
i.e., "poor spatial locality"</strong>. Throughout the calculation, it
is equivalent to accessing matrix B many, many times.</p>
<p>It is advisable to access the elements of multi-dimensional arrays in
sequential order. This can improve the spatial locality of memory access
and make it more friendly to the cache.</p>
<p>Furthermore, it can be observed that with the increase in size, the
performance fluctuates significantly. Analysis of the data shows that
when m=n=k is 128 164 192 228 256 288 320 352 384, the performance is
poor. These numbers differ by 32, and 32 * 4 (sizeof(float)) = 128
B.</p>
<p>It is speculated that the performance fluctuation is related to
cacheline and hardware prefetching -- cacheline = 64B, after cache miss,
hardware prefetching, i.e., HWPrefetcher, reads one more cacheline.</p>
<h2 id="version-1-loop-interchange-version">Version 1: Loop Interchange
Version</h2>
<p>Reusing data in the cache is the most basic and efficient use of
cache. For nested loops, <code>loop interchange</code>,
<code>loop reversal</code>, <code>loop fusion</code>,
<code>loop distribution</code>, <code>loop tiling</code>,
<code>loop unrolling and jam</code>, etc., can be used to improve
program performance.</p>
<p>Selecting an appropriate loop transformation method can both maintain
the semantics of the program and improve its performance.</p>
<p><img src=/images/sgemm/data/result_1.png width=70% /></p>
<p><img src=/images/sgemm/pics/step1.gif width=70% /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; m; i ++ ) &#123;              <span class="comment">// Start 2-th loop</span></span><br><span class="line">    <span class="keyword">for</span> ( p = <span class="number">0</span>; p &lt; k; p ++ ) &#123;          <span class="comment">// Start 1-st loop</span></span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; n; j ++ ) &#123;      <span class="comment">// Start 0-nd loop</span></span><br><span class="line">            C( i, j ) += A( i, p ) * B( p, j );</span><br><span class="line">        &#125;                                 <span class="comment">// End   0-th loop</span></span><br><span class="line">    &#125;                                     <span class="comment">// End   1-st loop</span></span><br><span class="line">&#125;                                         <span class="comment">// End   2-nd loop</span></span><br></pre></td></tr></table></figure>
<p>Compared with <code>version 0</code>, <code>version 1</code> has
better spatial locality for the operation on matrix B, and the
performance has been greatly improved (especially for larger sizes,
while for m = n = k &lt;= 68, the efficiency of version 0 is
higher).</p>
<p>Adjusting the order of m, n, and k does not affect the result (i.e.,
maintaining the semantics of the program), but it can affect the
performance. Testing the performance of different loop orders (using the
Allwinner Nezha D1 platform, with m=n=k=512 as an example)</p>
<table>
<thead>
<tr class="header">
<th>Loop Order</th>
<th>GFLOPS</th>
<th>Analysis</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MNK</td>
<td>0.012</td>
<td>High cache miss for accessing B</td>
</tr>
<tr class="even">
<td>MKN</td>
<td>0.180</td>
<td></td>
</tr>
<tr class="odd">
<td>NMK</td>
<td>0.012</td>
<td>High cache miss for accessing B</td>
</tr>
<tr class="even">
<td>NKM</td>
<td>0.009</td>
<td>High cache miss for accessing A</td>
</tr>
<tr class="odd">
<td>KMN</td>
<td>0.165</td>
<td></td>
</tr>
<tr class="even">
<td>KNM</td>
<td>0.009</td>
<td>High cache miss for accessing A</td>
</tr>
</tbody>
</table>
<p>However, the hardware utilization of <code>version 1</code> is still
very low, and further optimizations are needed.</p>
<h2 id="version-2-blocking-version">Version 2: Blocking Version</h2>
<p><img src=/images/sgemm/data/result_2.png width=70% /></p>
<p><img src=/images/sgemm/pics/step2.gif width=70% /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; m; i += DGEMM_MR ) &#123;          <span class="comment">// Start 2-nd loop</span></span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; n; j += DGEMM_NR ) &#123;      <span class="comment">// Start 1-st loop</span></span><br><span class="line">        AddDot_4x4_opt( k, &amp;A( i, <span class="number">0</span> ), lda, &amp;B( <span class="number">0</span>, j ), ldb, &amp;C( i, j ), ldc );</span><br><span class="line">    &#125;                                          <span class="comment">// End   1-st loop</span></span><br><span class="line">&#125;                                              <span class="comment">// End   2-nd loop</span></span><br></pre></td></tr></table></figure>
<p><img src=/images/sgemm/pics/gemm_block.png width=70% /></p>
<p>To avoid unnecessary cache swapping, blocking processing is
performed. <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/342923482">Discussing
Why Blocking Matrix Optimization Works</a> is a good read, I recommend
learning from it.</p>
<p>After performing block operations in <code>version 2</code>, the
performance is still not satisfactory. This is because, although this
version superficially implements blocking logic, there are still some
small tricks in the calculation within the block that have not been
applied.</p>
<h2 id="version-3-blocked-optimization-version">Version 3: Blocked
Optimization Version</h2>
<p><img src=/images/sgemm/data/result_3.png width=70% /></p>
<p><img src=/images/sgemm/pics/step3.gif width=70% /></p>
<p><code>AddDot_4x4_opt</code> has been added.</p>
<p>Several tricks are mentioned in<a
target="_blank" rel="noopener" href="https://github.com/flame/blislab/blob/master/tutorial.pdf">BLISlab-tutorial</a>:</p>
<ul>
<li>2.4.2 Loop unrolling
<ul>
<li>Updating loop index i and the pointer cp every time through the
inner loop creates considerable overhead. For this reason, a compiler
will perform loop unrolling.</li>
</ul></li>
<li>2.4.3 Register variables
<ul>
<li>Notice that computation can only happen if data is stored in
registers. A compiler will automatically transform code so that the
intermediate steps that place certain data in registers is
inserted.</li>
</ul></li>
</ul>
<p>After using these tricks, this version has significantly improved
performance!</p>
<p>However, for larger matrix sizes, the performance of this version is
still relatively low. Upon investigation, for example, after accessing
B[0,0], B[0,1], B[0,2], B[0,3], when accessing B[1,0], when the size is
large, there must be a <code>cache miss</code>. Therefore, it would be
great if the data could be rearranged in advance.</p>
<h2 id="version-4-b-prepack-version">Version 4: B prepack Version</h2>
<p><img src=/images/sgemm/data/result_4.png width=70% /></p>
<p><img src=/images/sgemm/pics/step4.gif width=70% /></p>
<p>I assume matrix B is <strong>parameter</strong>, so we can perform
the <code>pack</code> operation in advance. Version 4
<code>prepack</code> matrix B, leading to further performance
improvement!</p>
<p>The reason for the performance improvement is evident: there is a
significant reduction in <code>cache misses</code> when accessing matrix
B. This is the first time I deeply realized the importance of
<code>prepacking neural network weights</code> before model
inference.</p>
<p>It can be seen that when the size is relatively large, the
performance still declines. This should be due to a high number of cache
misses when accessing matrix A. Should we pack A?</p>
<p>I assume matrix A is <strong>input</strong>, so packing A cannot be
done in advance and must be included in the overall timing. Is it
necessary?</p>
<h2 id="version-5-a-pack-b-prepack-version">Version 5: A pack &amp; B
prepack Version</h2>
<p><img src=/images/sgemm/data/result_5.png width=70% /></p>
<p><img src=/images/sgemm/pics/step5.gif width=70% /></p>
<p>Based on Version 4, Version 5 performs packing on matrix A.</p>
<p>Here, since matrix A is assumed to be an input, packing A needs to be
performed during computation, and this time consumption needs to be
included in the timing.</p>
<p>The results are still pleasing, especially with large matrix sizes,
achieving further performance improvements.</p>
<p>I initially approached this experiment with a trial-and-error
mindset, considering the additional read of A and writing of packA. It
seems the main challenge ahead lies in combating cache misses.</p>
<p>The current optimization direction has reached its limit. It's worth
trying to do some <code>preload</code> during the calculation
process.</p>
<p>Next, we'll move to assembly, work on vector calculations, and
implement <code>preload</code> in assembly.</p>
<h2 id="version-6-assembly-version">Version 6: Assembly Version</h2>
<p><img src=/images/sgemm/data/result_6.png width=70% /></p>
<p>Brief explanation: A is not packed, but B is prepacked with 16
numbers.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; m; i += DGEMM_MR ) &#123;       <span class="comment">// Start 2-nd loop</span></span><br><span class="line">    <span class="type">int</span> mb = DGEMM_MR;</span><br><span class="line">    <span class="keyword">if</span>((m - i) &lt; DGEMM_MR) mb = m - i; </span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; n; j += DGEMM_NR ) &#123;   <span class="comment">// Start 1-st loop</span></span><br><span class="line">        <span class="type">int</span> nb = DGEMM_NR;</span><br><span class="line">        <span class="keyword">if</span>((n - j) &lt; DGEMM_NR) nb = n - j; </span><br><span class="line">        RvvSgemm4x16(   nb,                 <span class="comment">// nr &lt;= 16, a0</span></span><br><span class="line">                        mb,                 <span class="comment">// mr &lt;= 4,  a1</span></span><br><span class="line">                        k,                  <span class="comment">// astride = k*sizeof(float), a2</span></span><br><span class="line">                        &amp;A[i * k],          <span class="comment">// mr * k,   a3</span></span><br><span class="line">                        &amp;packB[j * k],      <span class="comment">// k * 16,   a4</span></span><br><span class="line">                        &amp;C( i, j ),         <span class="comment">// mr * nr,  a5</span></span><br><span class="line">                        n * <span class="keyword">sizeof</span>(<span class="type">float</span>),  <span class="comment">// Len(N) * sizeof(float), a6</span></span><br><span class="line">                        bias</span><br><span class="line">                    );</span><br><span class="line">    &#125;                                       <span class="comment">// End   1-st loop</span></span><br><span class="line">&#125;                                           <span class="comment">// End   2-nd loop</span></span><br></pre></td></tr></table></figure>
<p>Regarding the use of rvv instructions, I believe <code>vsetvli</code>
is essential, and <code>vfmacc.vf</code> is the mainstay.</p>
<p>I have learned a lot from <a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/474684731">OpenPPL Course | RISC-V
Technical Analysis</a>. They are truly professional! I recommend
learning theoretical guidance and knowledge points from them, paying
tribute to OpenPPL!</p>
<p>As for assembly operators, there are many details in assembly, and I
strongly complain: <strong>writing assembly is really annoying!
Especially the debugging process, it's torturous.</strong> The last time
I wrote assembly was during my undergraduate classes. Picking it up
again brings some novelty and excitement, and being able to control the
execution of operators at a very fine granularity gives a great sense of
accomplishment.</p>
<p>Regarding how the assembly files are implemented specifically, I
believe the fastest way is to look at the assembly code. I won't explain
it further here.</p>
<p>It should be noted that this version's performance is very poor. Why
is that? It's another issue of <strong>loop order</strong>.</p>
<h2 id="version-7-assembly-version-with-loop-order-swapped">Version 7:
Assembly Version with Loop Order Swapped</h2>
<p><img src=/images/sgemm/data/result_7.png width=70% /></p>
<p>Brief explanation: A is not packed, but B is prepacked with 16
numbers.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; n; j += DGEMM_NR ) &#123;       <span class="comment">// Start 2-st loop</span></span><br><span class="line">    <span class="type">int</span> nb = DGEMM_NR;</span><br><span class="line">    <span class="keyword">if</span>((n - j) &lt; DGEMM_NR) nb = n - j; </span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; m; i += DGEMM_MR ) &#123;   <span class="comment">// Start 1-nd loop</span></span><br><span class="line">        <span class="type">int</span> mb = DGEMM_MR;</span><br><span class="line">        <span class="keyword">if</span>((m - i) &lt; DGEMM_MR) mb = m - i; </span><br><span class="line">        RvvSgemm4x16(   nb,                 <span class="comment">// nr &lt;= 16, a0</span></span><br><span class="line">                        mb,                 <span class="comment">// mr &lt;= 4,  a1</span></span><br><span class="line">                        k,                  <span class="comment">// astride = k*sizeof(float), a2</span></span><br><span class="line">                        &amp;A[i * k],          <span class="comment">// mr * k,   a3</span></span><br><span class="line">                        &amp;packB[j * k],      <span class="comment">// k * 16,   a4</span></span><br><span class="line">                        &amp;C( i, j ),         <span class="comment">// mr * nr,  a5</span></span><br><span class="line">                        n * <span class="keyword">sizeof</span>(<span class="type">float</span>),  <span class="comment">// Len(N) * sizeof(float), a6</span></span><br><span class="line">                        bias</span><br><span class="line">                    );</span><br><span class="line">    &#125;                                       <span class="comment">// End   1-st loop</span></span><br><span class="line">&#125;                                           <span class="comment">// End   2-nd loop</span></span><br></pre></td></tr></table></figure>
<p>Reversing the order of loops, starting with the n-direction followed
by the m-direction, significantly improves performance.</p>
<p>However, the performance of large-sized matrices is still not very
good. The root cause remains in <code>memory access</code>. The
computation of large-sized matrices in the <code>roofline model</code>
is considered <code>compute-bound</code>, where ideally the
<code>compute time</code> and <code>memory access time</code> should
overlap as much as possible. Currently, a significant amount of time is
spent on memory access (mostly due to <code>cache miss</code>!).</p>
<h2 id="version-8-assembly-version-with-preload">Version 8: Assembly
Version with Preload</h2>
<p><img src=/images/sgemm/data/result_8.png width=70% /></p>
<p>Brief Explanation: Matrix A is not <code>packed</code>, while Matrix
B undergoes <code>prepackaging</code> of 16 elements and includes a
<code>preload</code> operation.</p>
<p>The performance is explosive! It reaches a maximum of
<code>2.212 GFLOPS</code>.</p>
<p>Core operations:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vfmacc.vf v16,  ft0, v0</span><br><span class="line">vlw.v v4, (bp0)         # b0&#x27;-&gt;v4</span><br><span class="line">flw fs4, 384(bp0)       # pre-load B</span><br><span class="line">addi bp0,bp0,64</span><br><span class="line">vfmacc.vf v20,  ft1, v0</span><br></pre></td></tr></table></figure>
<p>Inserting some <code>load</code> operations between
<code>vfmacc.vf</code> instructions preloads the data that will be used
later into the <code>cache</code>, significantly reducing
<code>cache miss</code>.</p>
<p>Initially, I was puzzled—how can the <code>compute time</code> and
<code>memory access time</code> overlap when the code seems to execute
sequentially? It wasn't until later that I understood the essence here,
which lies in the principle of <code>cacheline</code>. Indeed,
foundational knowledge is crucial!</p>
<h2 id="version-9-assembly-version-with-a-packed">Version 9: Assembly
Version with A Packed</h2>
<p><img src=/images/sgemm/data/result_9.png width=70% /></p>
<p>Based on previous experience, an attempt was made to
<code>pack</code> Matrix A, but surprisingly, the results were not very
good. A brief analysis suggests that the preload for Matrix A in this
version of the assembly code might not be optimized.</p>
<p>In the previous version, although A wasn't packed, there was preload
for A's 4 rows, which also addressed the pain point of cache miss for
Matrix A.</p>
<h1 id="conclusion">Conclusion</h1>
<p>To continue optimizing this operator, there is still much to be done,
such as rearranging pipelines in assembly.</p>
<p>As mentioned in the OpenPPL Course | RISC-V Technical Analysis, using
<code>vf</code> instructions can achieve 80% of the theoretical peak,
which is 4*80%, <code>3.2 GFLOPs</code>. I currently have only
<code>2.121 GFLOPs</code>, indicating there's still a lot of room for
optimization theoretically.</p>
<p>Furthermore, the RVV currently uses version 0.7.1, and it seems
there's still much work to be done in RVV instruction optimization, such
as the serious efficiency problem encountered with <code>vlw</code>.</p>
<p>In conclusion, working on these tasks has allowed me to learn a lot
from many experts, and I'm very grateful. I also hope this article can
help more people.</p>
<h1 id="acknowledgement">Acknowledgement</h1>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/flame/blislab">BLISlab: A Sandbox for
Optimizing GEMM</a></p>
<p>This project introduced me to how to optimize GEMM</p></li>
<li><p><a
target="_blank" rel="noopener" href="https://github.com/surez-ok/blislab_riscv">riscv平台优化矩阵乘(基于blislab优化实践)</a></p>
<p>I conduct experiments and exploration based on this project</p></li>
<li><p>Thanks to Mr. Ding for your guidance.</p></li>
</ul>
<h1 id="references">References</h1>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/474684731">OpenPPL 公开课 |
RISC-V 技术解析</a></p>
<p><a target="_blank" rel="noopener" href="http://riscvbook.com/">RISC-V-Reader</a></p>
<p><a
target="_blank" rel="noopener" href="https://github.com/riscv/riscv-v-spec/releases">riscv-v-spec-0.7.1</a></p>
<p><a
target="_blank" rel="noopener" href="https://www.cs.utexas.edu/users/pingali/CS378/2008sp/papers/gotoPaper.pdf">Anatomy
of High-Performance Matrix Multiplication</a></p>
<p><a
target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/forum/topic/0201105374686101528">编译器优化丨Cache优化</a></p>
<p><a
target="_blank" rel="noopener" href="https://www.leiphone.com/category/yanxishe/Puevv3ZWxn0heoEv.html">OpenBLAS项目与矩阵乘法优化
| AI 研习社</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/34204282">Roofline
Model与深度学习模型的性能分析</a></p>
<p><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/342923482">浅谈分块矩阵优化方法为什么有用</a></p>
<h1 id="thanks-for-your-support">Thanks for your support!</h1>
<p><a
target="_blank" rel="noopener" href="https://buymeacoffee.com/zhaodongyu"><strong>Buymeacoffee</strong></a>
<a target="_blank" rel="noopener" href="https://paypal.me/ZhaoDongyu"><strong>Paypal</strong></a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div>Thanks for your support.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      <div style="display: inline-block;">
        <img src="/images/money/buymeacoffee.jpg" alt="Zhao Dongyu Buymeacoffee">
        <p>Buymeacoffee</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/money/wechatpay.jpg" alt="Zhao Dongyu WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/money/alipay.jpg" alt="Zhao Dongyu Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/RISCV/" rel="tag"># RISCV</a>
              <a href="/tags/GEMM/" rel="tag"># GEMM</a>
              <a href="/tags/HPC/" rel="tag"># HPC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/02/17/98_Telegram_bot/" rel="prev" title="Telegram bot">
      <i class="fa fa-chevron-left"></i> Telegram bot
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/02/26/102_sgemm_riscv_cn/" rel="next" title="在riscv平台优化SGEMM">
      在riscv平台优化SGEMM <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#prerequisite-knowledge"><span class="nav-number">1.</span> <span class="nav-text">Prerequisite Knowledge</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#prepare"><span class="nav-number">2.</span> <span class="nav-text">Prepare</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#test-cross-compilation"><span class="nav-number">2.1.</span> <span class="nav-text">Test Cross-Compilation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#memory-bandwidth-test"><span class="nav-number">2.2.</span> <span class="nav-text">Memory Bandwidth Test</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#roofline-model"><span class="nav-number">2.3.</span> <span class="nav-text">Roofline Model</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#sgemm-optimization"><span class="nav-number">3.</span> <span class="nav-text">SGEMM Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#usage"><span class="nav-number">3.1.</span> <span class="nav-text">Usage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-0-naive-version"><span class="nav-number">3.2.</span> <span class="nav-text">Version 0: Naive Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-1-loop-interchange-version"><span class="nav-number">3.3.</span> <span class="nav-text">Version 1: Loop Interchange
Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-2-blocking-version"><span class="nav-number">3.4.</span> <span class="nav-text">Version 2: Blocking Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-3-blocked-optimization-version"><span class="nav-number">3.5.</span> <span class="nav-text">Version 3: Blocked
Optimization Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-4-b-prepack-version"><span class="nav-number">3.6.</span> <span class="nav-text">Version 4: B prepack Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-5-a-pack-b-prepack-version"><span class="nav-number">3.7.</span> <span class="nav-text">Version 5: A pack &amp; B
prepack Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-6-assembly-version"><span class="nav-number">3.8.</span> <span class="nav-text">Version 6: Assembly Version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-7-assembly-version-with-loop-order-swapped"><span class="nav-number">3.9.</span> <span class="nav-text">Version 7:
Assembly Version with Loop Order Swapped</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-8-assembly-version-with-preload"><span class="nav-number">3.10.</span> <span class="nav-text">Version 8: Assembly
Version with Preload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#version-9-assembly-version-with-a-packed"><span class="nav-number">3.11.</span> <span class="nav-text">Version 9: Assembly
Version with A Packed</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#conclusion"><span class="nav-number">4.</span> <span class="nav-text">Conclusion</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#acknowledgement"><span class="nav-number">5.</span> <span class="nav-text">Acknowledgement</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#references"><span class="nav-number">6.</span> <span class="nav-text">References</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#thanks-for-your-support"><span class="nav-number">7.</span> <span class="nav-text">Thanks for your support!</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhao Dongyu"
      src="/images/zhaodongyu.jpg">
  <p class="site-author-name" itemprop="name">Zhao Dongyu</p>
  <div class="site-description" itemprop="description">Here is Zhao Dongyu's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Zhao-Dongyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Zhao-Dongyu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhaodongyu@pku.edu.cn" title="E-Mail → mailto:zhaodongyu@pku.edu.cn" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/18783794/ak47" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;18783794&#x2F;ak47" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://youtube.com/@andyzhao2923" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;@andyzhao2923" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
  </div>



<br>
<div style="width: 210px; height: 210px;">
  <script async type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=iTM1NNRJIGaMvOAMCKq-UVRPmqJ8gfGcaUAEGH7qVKo"></script>
</div>
<p>Visitors Distribution</p>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user-astronaut"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhao Dongyu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">148k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">2:15</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '82b57e0cfa4752bb12bb',
      clientSecret: 'b173169d558751dc60eb82b84c876435494f4aa0',
      repo        : 'zhao-dongyu.github.io',
      owner       : 'zhao-dongyu',
      admin       : ['zhao-dongyu'],
      id          : '48d8f0102a35ceb2c393427c290f7ebf',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


  
  
</body>
</html>
